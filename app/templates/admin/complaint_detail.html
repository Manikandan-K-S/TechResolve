{% extends 'admin/admin_layout.html' %}

{% block title %}Complaint Details{% endblock %}

{% block content %}
<!-- Header with navigation -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('admin.complaint_list') }}" class="text-gray-500 hover:text-indigo-600" title="Back to complaints list">
                <i class="fas fa-arrow-left"></i>
                <span class="sr-only">Back to complaints list</span>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">Complaint {{ complaint.complaint_id }}</h1>
            {% if complaint.archived %}
            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 flex items-center gap-1">
                <i class="fas fa-archive text-xs"></i>
                Archived
            </span>
            {% endif %}
        </div>
        <p class="text-gray-600">Submitted on {{ complaint.created_at.strftime('%d %b %Y at %H:%M') }}</p>
    </div>
    
    <div class="flex items-center gap-3 bg-gray-50 px-4 py-2 rounded-lg">
        <div class="text-xs font-medium">
            Status: 
            <span class="badge 
                {% if complaint.status == 'Pending' %}badge-pending
                {% elif complaint.status == 'In Progress' %}badge-in-progress
                {% elif complaint.status == 'Resolved' %}badge-resolved
                {% elif complaint.status == 'Terminated' %}badge-terminated
                {% endif %}">
                {{ complaint.status }}
            </span>
        </div>
        <div class="text-xs font-medium">
            Priority:
            <span class="badge 
                {% if complaint.priority == 'High' %}badge-high
                {% elif complaint.priority == 'Medium' %}badge-medium
                {% else %}badge-low
                {% endif %}">
                {{ complaint.priority or 'Low' }}
            </span>
        </div>
        <div class="text-xs font-medium">
            Last update: 
            <span class="text-gray-700">{{ complaint.updated_at.strftime('%d %b %Y %H:%M') }}</span>
        </div>
    </div>
</div>

<!-- Main content grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column: Details -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Complaint details card -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="card-header">
                <h3 class="font-semibold text-gray-700">Complaint Information</h3>
                {% if complaint.attachment_path %}
                <a href="{{ url_for('main.uploaded_file', filename=complaint.attachment_path) }}" 
                   target="_blank" 
                   class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center gap-1">
                    <i class="fas fa-paperclip"></i>
                    <span>View Attachment</span>
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 uppercase">Reporter</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-700 text-sm font-medium">
                                    {{ complaint.name[0] }}
                                </span>
                                <div>
                                    <p class="font-medium text-gray-900">{{ complaint.name }}</p>
                                    <p class="text-sm text-gray-500">{{ complaint.email }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 uppercase">Location & Type</h4>
                            <div class="mt-1">
                                <p class="font-medium text-gray-900">{{ complaint.lab.name }}</p>
                                <p class="text-sm text-gray-500">{{ complaint.category }}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 uppercase">Tags</h4>
                            <div class="mt-1 flex flex-wrap gap-2">
                                {% if complaint.tags and complaint.tags != 'none' %}
                                    {% for tag in complaint.tags.split(',') %}
                                    <span class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded-full">{{ tag.strip() }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-sm text-gray-500">No tags</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 uppercase">Assigned Admin</h4>
                            <div class="mt-1">
                                {% if complaint.assigned_admin %}
                                <div class="flex items-center gap-2">
                                    <span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 text-xs font-medium">
                                        {{ complaint.assigned_admin.name[0] }}
                                    </span>
                                    <span class="text-gray-900">{{ complaint.assigned_admin.name }}</span>
                                </div>
                                {% else %}
                                <p class="text-gray-500 text-sm">Not assigned</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">Description</h4>
                        <div class="bg-gray-50 p-4 rounded-md text-gray-900 text-sm h-full overflow-auto">
                            {{ complaint.description|nl2br }}
                        </div>
                    </div>
                </div>
                
                {% if complaint.resolution_notes %}
                <div>
                    <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">Resolution Notes</h4>
                    <div class="bg-green-50 border border-green-100 p-4 rounded-md text-gray-900 text-sm">
                        {{ complaint.resolution_notes|nl2br }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Activity timeline -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="card-header">
                <h3 class="font-semibold text-gray-700">Activity Timeline</h3>
                <span class="text-gray-500 text-sm">{{ complaint_logs|length }} activities</span>
            </div>
            <div class="card-body">
                <div class="space-y-6">
                    {% for log in complaint_logs %}
                    <div class="timeline-item">
                        <div class="timeline-marker 
                            {% if log.action == 'STATUS_CHANGED' %}bg-blue-500
                            {% elif log.action == 'ADMIN_ASSIGNED' %}bg-purple-500
                            {% elif log.action == 'TAG_CHANGED' %}bg-yellow-500
                            {% elif log.action == 'DESCRIPTION_ADDED' %}bg-green-500
                            {% else %}bg-gray-500{% endif %}">
                        </div>
                        
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-sm font-medium text-gray-800">
                                    {% if log.action == 'ISSUE_VIEWED' %}
                                        <i class="fas fa-eye text-gray-400 mr-1"></i> Viewed the complaint
                                        {% if log.view_duration %}<span class="text-xs text-gray-500">({{ log.view_duration }}s)</span>{% endif %}
                                    {% elif log.action == 'STATUS_CHANGED' %}
                                        <i class="fas fa-exchange-alt text-blue-500 mr-1"></i> Status changed from 
                                        <span class="font-medium">{{ log.old_value or 'Unknown' }}</span> to 
                                        <span class="font-medium">{{ log.new_value }}</span>
                                    {% elif log.action == 'TAG_CHANGED' %}
                                        <i class="fas fa-tags text-yellow-500 mr-1"></i> Tags updated from 
                                        <span class="font-medium">{{ log.old_value or 'none' }}</span> to 
                                        <span class="font-medium">{{ log.new_value }}</span>
                                    {% elif log.action == 'DESCRIPTION_ADDED' %}
                                        <i class="fas fa-comment-alt text-green-500 mr-1"></i> Added description
                                    {% elif log.action == 'ADMIN_ASSIGNED' %}
                                        <i class="fas fa-user-check text-purple-500 mr-1"></i> Assigned to 
                                        <span class="font-medium">{{ log.new_value }}</span>
                                    {% elif log.action == 'ADMIN_UNASSIGNED' %}
                                        <i class="fas fa-user-minus text-red-500 mr-1"></i> Unassigned 
                                        <span class="font-medium">{{ log.old_value }}</span>
                                    {% else %}
                                        <i class="fas fa-history text-gray-500 mr-1"></i> {{ log.action.replace('_', ' ').title() }}
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    By {{ log.admin.name if log.admin else 'System' }}
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ log.timestamp.strftime('%d %b %Y, %H:%M') }}
                            </div>
                        </div>
                        
                        {% if log.description %}
                            {% if log.action == 'DESCRIPTION_ADDED' %}
                                <div class="mt-2 p-3 bg-gray-50 rounded-md text-sm text-gray-700">{{ log.description }}</div>
                            {% else %}
                                <div class="mt-1 text-sm text-gray-600">Remarks: {{ log.description }}</div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="py-6 text-center text-gray-500">
                        <i class="fas fa-history text-gray-300 text-3xl mb-2"></i>
                        <p>No activity recorded yet</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right column: Actions -->
    <div>
        <!-- Actions card -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden sticky top-20">
            <div class="card-header">
                <h3 class="font-semibold text-gray-700">Update Complaint</h3>
            </div>
            <div class="card-body">
                <form method="POST" class="space-y-4">
                    <div class="form-group">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-control">
                            <option value="Pending" {% if complaint.status=='Pending' %}selected{% endif %}>Pending</option>
                            <option value="In Progress" {% if complaint.status=='In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Resolved" {% if complaint.status=='Resolved' %}selected{% endif %}>Resolved</option>
                            <option value="Terminated" {% if complaint.status=='Terminated' %}selected{% endif %}>Terminated</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select id="priority" name="priority" class="form-control">
                            <option value="Low" {% if complaint.priority=='Low' %}selected{% endif %}>Low</option>
                            <option value="Medium" {% if complaint.priority=='Medium' %}selected{% endif %}>Medium</option>
                            <option value="High" {% if complaint.priority=='High' %}selected{% endif %}>High</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="assigned_admin" class="form-label">Assign / Tag Admin</label>
                        <select id="assigned_admin" name="assigned_admin" class="form-control">
                            <option value="">-- Unassigned --</option>
                            {% for admin in admins %}
                            <option value="{{ admin.id }}" {% if complaint.assigned_admin_id == admin.id %}selected{% endif %}>{{ admin.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tags" class="form-label">Tags</label>
                        <input id="tags" name="tags" type="text" value="{{ complaint.tags }}" class="form-control" placeholder="hardware,software,network">
                        <p class="text-xs text-gray-500 mt-1">Separate tags with commas</p>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">Add Description</label>
                        <textarea id="description" name="description" rows="3" class="form-control" placeholder="Add your notes about the investigation"></textarea>
                        <p class="text-xs text-gray-500 mt-1">This will be logged as an activity</p>
                    </div>

                    <div class="form-group">
                        <label for="remarks" class="form-label">Action Remarks</label>
                        <textarea id="remarks" name="remarks" rows="2" class="form-control" placeholder="Reason for status change, etc."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Will be attached to status/assignment changes</p>
                    </div>

                    <div class="form-group">
                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                        <textarea id="resolution_notes" name="resolution_notes" rows="3" class="form-control">{{ complaint.resolution_notes or '' }}</textarea>
                        <p class="text-xs text-gray-500 mt-1">These notes will be visible to the user</p>
                    </div>

                    <div class="flex items-center">
                        <input id="archived" name="archived" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" {% if complaint.archived %}checked{% endif %}>
                        <label for="archived" class="ml-2 text-sm text-gray-700">Archive complaint</label>
                    </div>

                    <div class="pt-2">
                        <button type="submit" class="btn btn-primary w-full">
                            <i class="fas fa-save"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if view_log_id %}
<div id="view-log-meta"
     data-log-id="{{ view_log_id }}"
     data-endpoint="{{ url_for('admin.complaint_view_duration', id=complaint.id) }}"></div>
<script>
    (function() {
        const meta = document.getElementById('view-log-meta');
        if (!meta) { return; }

        const start = Date.now();
        const logId = meta.dataset.logId;
        const endpoint = meta.dataset.endpoint;

        function sendDuration() {
            const seconds = Math.round((Date.now() - start) / 1000);
            navigator.sendBeacon(
                endpoint,
                new Blob([JSON.stringify({ log_id: logId, duration: seconds })], { type: 'application/json' })
            );
        }

        window.addEventListener('beforeunload', sendDuration);
    })();
</script>
{% endif %}
{% endblock %}
