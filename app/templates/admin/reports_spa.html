{% extends 'admin/admin_layout.html' %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Complaint Reports</h1>
    <p class="text-gray-600">View analytics and generate reports</p>
</div>

<div class="grid grid-cols-1 gap-6">
    <!-- Reports by time -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="card-header">
            <h3 class="font-semibold text-gray-700">Complaint Trends</h3>
            <div class="flex items-center gap-2">
                <label class="sr-only" for="timeRangeFilter">Time Range</label>
                <select id="timeRangeFilter" class="text-sm border-gray-300 rounded-md" aria-label="Select time range">
                    <option value="month">Last 30 Days</option>
                    <option value="quarter">Last Quarter</option>
                    <option value="year">Last Year</option>
                </select>
                <button type="button" class="text-indigo-600 hover:text-indigo-800 text-sm">
                    <i class="fas fa-download mr-1"></i>
                    Export
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="h-80">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Reports by category -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="card-header">
                <h3 class="font-semibold text-gray-700">Complaints by Category</h3>
            </div>
            <div class="card-body">
                <div class="h-64">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="card-header">
                <h3 class="font-semibold text-gray-700">Complaints by Lab</h3>
            </div>
            <div class="card-body">
                <div class="h-64">
                    <canvas id="labChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resolution time stats -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="card-header">
            <h3 class="font-semibold text-gray-700">Resolution Time Statistics</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-indigo-600" id="avgResolutionTime">00:00</div>
                    <div class="text-sm text-gray-500">Average Resolution Time</div>
                </div>
                
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="minResolutionTime">00:00</div>
                    <div class="text-sm text-gray-500">Fastest Resolution</div>
                </div>
                
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-600" id="maxResolutionTime">00:00</div>
                    <div class="text-sm text-gray-500">Slowest Resolution</div>
                </div>
                
                <div class="text-center">
                    <div class="text-3xl font-bold text-amber-600" id="unresolved">0</div>
                    <div class="text-sm text-gray-500">Still Unresolved</div>
                </div>
            </div>
            
            <div class="h-64">
                <canvas id="resolutionTimeChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Generate reports section -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="card-header">
            <h3 class="font-semibold text-gray-700">Generate Report</h3>
        </div>
        <div class="card-body">
            <form class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="reportType" class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                    <select id="reportType" class="form-control">
                        <option value="summary">Summary Report</option>
                        <option value="detailed">Detailed Report</option>
                        <option value="lab">Lab-specific Report</option>
                        <option value="admin">Admin Performance Report</option>
                    </select>
                </div>
                
                <div>
                    <label for="dateRange" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <select id="dateRange" class="form-control">
                        <option value="7days">Last 7 Days</option>
                        <option value="30days">Last 30 Days</option>
                        <option value="90days">Last Quarter</option>
                        <option value="365days">Last Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div>
                    <label for="format" class="block text-sm font-medium text-gray-700 mb-1">Format</label>
                    <select id="format" class="form-control">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                
                <div class="md:col-span-3">
                    <button type="button" class="btn btn-primary">
                        <i class="fas fa-file-export"></i>
                        <span>Generate Report</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sample data for charts
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    
    const lastSixMonths = months.slice(currentMonth - 5 >= 0 ? currentMonth - 5 : (12 + currentMonth - 5), currentMonth + 1);
    if (lastSixMonths.length < 6) {
        lastSixMonths.unshift(...months.slice(12 + currentMonth - 5, 12));
    }
    
    // Fetch real data from API
    fetch('/admin/api/reports')
    .then(response => response.json())
    .then(data => {
        updateCharts(data);
        updateStats(data);
    })
    .catch(error => {
        console.error('Error fetching report data:', error);
        // Use sample data if API fails
        const sampleData = getSampleData();
        updateCharts(sampleData);
        updateStats(sampleData);
    });

    function getSampleData() {
        return {
            complaints_by_month: [
                {month: '2023-07', count: 45},
                {month: '2023-08', count: 39},
                {month: '2023-09', count: 60},
                {month: '2023-10', count: 75},
                {month: '2023-11', count: 82},
                {month: '2023-12', count: 68}
            ],
            complaints_by_category: [
                {category: 'Hardware', count: 125},
                {category: 'Software', count: 96},
                {category: 'Network', count: 65},
                {category: 'Other', count: 42}
            ],
            complaints_by_lab: [
                {lab: 'Lab 1', count: 65},
                {lab: 'Lab 2', count: 85},
                {lab: 'Lab 3', count: 45},
                {lab: 'Lab 4', count: 37},
                {lab: 'Lab 5', count: 95}
            ],
            resolution_time_avg: 4.53
        };
    }

    function updateCharts(data) {
        // Trends chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const trendData = data.complaints_by_month || [];
        const trendLabels = trendData.map(item => {
            if (typeof item.month === 'string') {
                const [year, month] = item.month.split('-');
                return months[parseInt(month) - 1];
            } else {
                // Handle case where item.month is already processed
                return months[new Date(item.month).getMonth()];
            }
        }).slice(-6);
        
        const trendCounts = trendData.map(item => item.count).slice(-6);
        
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [
                    {
                        label: 'Complaints',
                        data: trendCounts,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
        
        // Category chart
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        const categoryData = data.complaints_by_category || [];
        const categoryLabels = categoryData.map(item => item.category);
        const categoryCounts = categoryData.map(item => item.count);
        
        new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryCounts,
                    backgroundColor: [
                        '#4f46e5',  // indigo
                        '#0ea5e9',  // sky
                        '#f59e0b',  // amber
                        '#d1d5db',  // gray
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Lab chart
        const labCtx = document.getElementById('labChart').getContext('2d');
        const labData = data.complaints_by_lab || [];
        const labLabels = labData.map(item => item.lab);
        const labCounts = labData.map(item => item.count);
        
        new Chart(labCtx, {
            type: 'bar',
            data: {
                labels: labLabels,
                datasets: [{
                    label: 'Complaints',
                    data: labCounts,
                    backgroundColor: '#4f46e5',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
        
        // Resolution time chart
        const resolutionTimeCtx = document.getElementById('resolutionTimeChart').getContext('2d');
        const bucketLabels = ['0-1h', '1-3h', '3-8h', '8-24h', '1-3d', '3-7d', '7d+'];
        const bucketData = data.resolution_buckets ? 
            bucketLabels.map(label => data.resolution_buckets[label] || 0) :
            [25, 45, 78, 36, 28, 12, 5]; // fallback data
            
        new Chart(resolutionTimeCtx, {
            type: 'bar',
            data: {
                labels: bucketLabels,
                datasets: [{
                    label: 'Number of Complaints',
                    data: bucketData,
                    backgroundColor: '#4f46e5',
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Resolution Time Distribution',
                        font: {
                            size: 14
                        }
                    }
                }
            }
        });
    }

    function updateStats(data) {
        // Set resolution time stats
        const avgHours = data.resolution_time_avg || 0;
        const hours = Math.floor(avgHours);
        const minutes = Math.round((avgHours - hours) * 60);
        
        document.getElementById('avgResolutionTime').textContent = `${hours}h ${minutes}m`;
        
        // Use actual min/max times from API
        document.getElementById('minResolutionTime').textContent = data.min_resolution_time || '0m';
        document.getElementById('maxResolutionTime').textContent = data.max_resolution_time || '0h';
        
        // Use unresolved count from API or calculate if not available
        let unresolved = data.unresolved_count;
        if (unresolved === undefined && data.complaints_by_category) {
            unresolved = data.complaints_by_category.reduce((total, item) => total + item.count, 0) - 
                         (data.resolved_count || 0);
        }
        document.getElementById('unresolved').textContent = unresolved || 0;
        
        console.log("Report data successfully loaded:", data);
    }
});
</script>
{% endblock %}