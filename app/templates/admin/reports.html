{% extends 'admin/admin_layout.html' %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Reports & Analytics</h1>
    <p class="text-gray-600">Comprehensive insights into complaint management</p>
</div>

<!-- Key Metrics Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
    <div class="stat-card border-indigo-500">
        <div class="stat-icon bg-indigo-100 text-indigo-600">
            <i class="fas fa-clipboard-list text-xl"></i>
        </div>
        <div>
            <div class="text-sm font-medium text-gray-500">Total Complaints</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_complaints }}</div>
            <div class="text-xs text-gray-500 mt-1">All time</div>
        </div>
    </div>

    <div class="stat-card border-green-500">
        <div class="stat-icon bg-green-100 text-green-600">
            <i class="fas fa-check-circle text-xl"></i>
        </div>
        <div>
            <div class="text-sm font-medium text-gray-500">Resolution Rate</div>
            <div class="text-2xl font-bold text-gray-800">{{ resolution_rate }}%</div>
            <div class="text-xs text-green-600 mt-1">Resolved complaints</div>
        </div>
    </div>

    <div class="stat-card border-blue-500">
        <div class="stat-icon bg-blue-100 text-blue-600">
            <i class="fas fa-clock text-xl"></i>
        </div>
        <div>
            <div class="text-sm font-medium text-gray-500">Avg. Resolution Time</div>
            <div class="text-2xl font-bold text-gray-800">{{ avg_resolution_time }}</div>
            <div class="text-xs text-gray-500 mt-1">Hours</div>
        </div>
    </div>

    <div class="stat-card border-amber-500">
        <div class="stat-icon bg-amber-100 text-amber-600">
            <i class="fas fa-exclamation-triangle text-xl"></i>
        </div>
        <div>
            <div class="text-sm font-medium text-gray-500">High Priority</div>
            <div class="text-2xl font-bold text-gray-800">{{ high_priority_count }}</div>
            <div class="text-xs text-amber-600 mt-1">Requires attention</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Lab Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Complaints by Lab</h3>
            <span class="text-sm text-gray-500">Total: {{ lab_data|sum }}</span>
        </div>
        <div class="h-80">
            <canvas id="labChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4">
            {% for lab, count in lab_details %}
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-700">{{ lab }}</span>
                <span class="text-sm font-bold text-indigo-600">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Category Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Complaints by Category</h3>
            <span class="text-sm text-gray-500">Total: {{ cat_data|sum }}</span>
        </div>
        <div class="h-80">
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="mt-4 space-y-2">
            {% for cat, count in cat_details %}
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-700">{{ cat }}</span>
                <div class="flex items-center gap-3">
                    <div class="w-32 bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ (count / cat_data|sum * 100)|round }}%"></div>
                    </div>
                    <span class="text-sm font-bold text-indigo-600">{{ count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Status and Priority Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Status Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Status Distribution</h3>
        <div class="h-64">
            <canvas id="statusChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div class="text-xs text-amber-600 font-medium">Pending</div>
                <div class="text-2xl font-bold text-amber-700">{{ status_counts.Pending or 0 }}</div>
            </div>
            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="text-xs text-blue-600 font-medium">In Progress</div>
                <div class="text-2xl font-bold text-blue-700">{{ status_counts['In Progress'] or 0 }}</div>
            </div>
            <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                <div class="text-xs text-green-600 font-medium">Resolved</div>
                <div class="text-2xl font-bold text-green-700">{{ status_counts.Resolved or 0 }}</div>
            </div>
            <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                <div class="text-xs text-red-600 font-medium">Terminated</div>
                <div class="text-2xl font-bold text-red-700">{{ status_counts.Terminated or 0 }}</div>
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Priority Distribution</h3>
        <div class="h-64">
            <canvas id="priorityChart"></canvas>
        </div>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                <div>
                    <div class="text-xs text-red-600 font-medium">High Priority</div>
                    <div class="text-sm text-gray-600 mt-1">Immediate attention required</div>
                </div>
                <div class="text-2xl font-bold text-red-700">{{ priority_counts.High or 0 }}</div>
            </div>
            <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div>
                    <div class="text-xs text-amber-600 font-medium">Medium Priority</div>
                    <div class="text-sm text-gray-600 mt-1">Standard processing time</div>
                </div>
                <div class="text-2xl font-bold text-amber-700">{{ priority_counts.Medium or 0 }}</div>
            </div>
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                <div>
                    <div class="text-xs text-green-600 font-medium">Low Priority</div>
                    <div class="text-sm text-gray-600 mt-1">Normal processing queue</div>
                </div>
                <div class="text-2xl font-bold text-green-700">{{ priority_counts.Low or 0 }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Performance -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-700 mb-4">Admin Performance</h3>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Admin</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lab</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Assigned</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resolved</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">In Progress</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resolution Rate</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg. Response Time</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for admin in admin_performance %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <span class="text-indigo-600 font-semibold">{{ admin.name[0] }}</span>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">{{ admin.name }}</div>
                                <div class="text-xs text-gray-500">{{ admin.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ admin.lab.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ admin.total_assigned }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">{{ admin.resolved_count }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">{{ admin.in_progress_count }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: {{ admin.resolution_rate }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{{ admin.resolution_rate }}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ admin.avg_response_time }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Monthly Trend -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Complaint Trend</h3>
    <div class="h-80">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<!-- Export Options -->
<div class="bg-white rounded-xl shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-700 mb-4">Export Reports</h3>
    <div class="flex flex-wrap gap-4">
        <button class="btn btn-primary">
            <i class="fas fa-file-pdf"></i>
            <span>Export as PDF</span>
        </button>
        <button class="btn btn-success">
            <i class="fas fa-file-excel"></i>
            <span>Export as Excel</span>
        </button>
        <button class="btn btn-secondary">
            <i class="fas fa-file-csv"></i>
            <span>Export as CSV</span>
        </button>
        <button class="btn btn-secondary">
            <i class="fas fa-print"></i>
            <span>Print Report</span>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lab Chart
    const labCtx = document.getElementById('labChart').getContext('2d');
    new Chart(labCtx, {
        type: 'bar',
        data: {
            labels: {{ lab_labels|safe }},
            datasets: [{
                label: 'Number of Complaints',
                data: {{ lab_data|safe }},
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Category Chart
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(catCtx, {
        type: 'doughnut',
        data: {
            labels: {{ cat_labels|safe }},
            datasets: [{
                data: {{ cat_data|safe }},
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                    '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 15 }
                }
            }
        }
    });

    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Pending', 'In Progress', 'Resolved', 'Terminated'],
            datasets: [{
                data: [
                    {{ status_counts.Pending or 0 }},
                    {{ status_counts['In Progress'] or 0 }},
                    {{ status_counts.Resolved or 0 }},
                    {{ status_counts.Terminated or 0 }}
                ],
                backgroundColor: ['#fbbf24', '#60a5fa', '#34d399', '#f87171'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Priority Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    {{ priority_counts.High or 0 }},
                    {{ priority_counts.Medium or 0 }},
                    {{ priority_counts.Low or 0 }}
                ],
                backgroundColor: ['#f87171', '#fbbf24', '#34d399'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [{
                label: 'Complaints',
                data: {{ trend_data|safe }},
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
});
</script>
{% endblock %}